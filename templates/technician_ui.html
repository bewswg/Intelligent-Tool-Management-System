<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Tool Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .action-card {
            transition: all 0.2s ease-in-out;
            min-height: 120px;
        }
        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .tool-card {
            transition: all 0.2s ease-in-out;
        }
        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-go { background-color: #dcfce7; color: #166534; }
        .status-warning { background-color: #fef9c3; color: #854d0e; }
        .status-no-go { background-color: #fecaca; color: #b91c1c; }
        .status-overdue { background-color: #ddd6fe; color: #7e22ce; }
        .nfc-icon {
            font-size: 4rem;
            color: #3b82f6;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center p-2 md:p-4">
    <div id="main-screen" class="w-full max-w-6xl bg-white rounded-xl shadow-lg p-3 md:p-5">
        <div id="idle-screen" class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold mb-4">Smart Tool Station</h1>
            <p class="text-gray-600 mb-6">Please authenticate by tapping your NFC card.</p>
            <div class="flex flex-col items-center">
                <div class="nfc-icon">üì°</div>
                <button id="tap-card-btn" class="w-full md:w-1/2 bg-blue-600 text-white py-4 text-lg rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center">
                    <span class="mr-3">üëâ</span> Tap NFC Card to Log In
                </button>
            </div>
        </div>

        <div id="auth-dashboard" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl md:text-2xl font-semibold">Welcome, <span id="welcome-user-name">User</span>!</h1>
                <button id="logout-btn" class="text-sm md:text-base text-red-600 hover:underline font-medium">Logout</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div id="checkout-card" class="action-card p-4 border-2 border-blue-500 rounded-xl bg-blue-50 cursor-pointer flex flex-col items-center justify-center">
                    <div class="text-blue-700 text-4xl mb-2">üß∞</div>
                    <h2 class="text-lg md:text-xl font-bold text-center">Check Out Tools</h2>
                    <p class="text-blue-600 text-center mt-1 text-sm">Start a new project or select tools manually</p>
                </div>
                <div id="return-card" class="action-card p-4 border-2 border-green-500 rounded-xl bg-green-50 cursor-pointer flex flex-col items-center justify-center">
                    <div class="text-green-700 text-4xl mb-2">‚Ü©Ô∏è</div>
                    <h2 class="text-lg md:text-xl font-bold text-center">Return Tools</h2>
                    <p class="text-green-600 text-center mt-1 text-sm">Return your checked-out tools</p>
                </div>
                <div id="emergency-card" class="action-card p-4 border-2 border-red-500 rounded-xl bg-red-50 cursor-pointer flex flex-col items-center justify-center">
                    <div class="text-red-700 text-4xl mb-2">üÜò</div>
                    <h2 class="text-lg md:text-xl font-bold text-center">Report Issue</h2>
                    <p class="text-red-600 text-center mt-1 text-sm">Report damaged or lost tools</p>
                </div>
            </div>
        </div>

        <div id="checkout-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl md:text-2xl font-semibold">Check Out Tools</h2>
                <button id="back-to-dashboard-checkout" class="text-sm md:text-base text-blue-600 hover:underline">Back to Dashboard</button>
            </div>

            <div id="project-view" class="mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-medium">Select a Project:</h3>
                    <button id="show-overall-tools-btn" class="text-sm md:text-base text-blue-600 hover:underline">Show All Tools</button>
                </div>
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    </div>
            </div>

            <div id="project-details-view" class="hidden mb-4">
                <button id="back-to-projects-btn" class="mb-3 text-sm md:text-base text-blue-600 hover:underline">&larr; Back to Projects</button>
                <h3 class="text-lg font-medium mb-1" id="project-detail-name">[Project Name]</h3>
                <p class="text-gray-700 text-sm mb-4" id="project-detail-briefing">[Project Briefing]</p>
                
                <h4 class="font-medium mb-2">Required Tools:</h4>
                <div id="project-tools-list" class="space-y-3 mb-4">
                    </div>
                <div class="flex space-x-2">
                    <button id="checkout-selected-tools-btn" class="flex-1 bg-green-600 text-white py-3 text-lg rounded">Checkout Selected</button>
                    <button id="checkout-all-tools-btn" class="flex-1 bg-blue-600 text-white py-3 text-lg rounded">Checkout All</button>
                </div>
            </div>

            <div id="overall-tools-view" class="hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-medium">All Available Tools:</h3>
                    <button id="back-to-projects-from-overall-btn" class="text-sm md:text-base text-blue-600 hover:underline">Back to Projects</button>
                </div>
                <div id="overall-tools-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4">
                    </div>
                <button id="manual-checkout-btn" class="w-full bg-blue-600 text-white py-3 text-lg rounded">Confirm Checkout</button>
            </div>
        </div>

        <div id="return-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl md:text-2xl font-semibold">Return Tools</h2>
                <button id="back-to-dashboard-return" class="text-sm md:text-base text-blue-600 hover:underline">Back to Dashboard</button>
            </div>
            <div id="return-tools-list" class="space-y-3 mb-4">
                </div>
            <p id="no-tools-message" class="text-gray-500 text-center py-4 hidden">You have no tools checked out.</p>
        </div>

        <div id="return-verification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md">
                <h3 class="text-xl font-semibold mb-4">Verify Tool Return</h3>
                <p class="mb-4">Please place the tool back in the box and close the door for verification.</p>
                <div class="flex space-x-2">
                    <button id="simulate-verification-btn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded">Simulate Verification</button>
                    <button id="cancel-verification-btn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded">Cancel</button>
                </div>
            </div>
        </div>

        <div id="return-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 w-11/12 max-w-md">
                <h3 class="text-xl font-semibold mb-4">Confirm Tool Return</h3>
                <p id="confirm-tool-name" class="mb-4">Tool: [Tool Name]</p>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="report-issue-checkbox" class="mr-2">
                        <span>Report Damage or Issue</span>
                    </label>
                </div>
                <div class="flex space-x-2">
                    <button id="confirm-return-btn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded">Confirm Return</button>
                    <button id="back-to-verification-btn" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded">Back</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentProjectId = null;
        let selectedToolForManualCheckout = null;
        let toolToReturn = null;
        let toolToReturnName = "";

        // DOM Elements
        const mainScreen = document.getElementById('main-screen');
        const idleScreen = document.getElementById('idle-screen');
        const authDashboard = document.getElementById('auth-dashboard');
        const checkoutSection = document.getElementById('checkout-section');
        const returnSection = document.getElementById('return-section');
        const welcomeUserName = document.getElementById('welcome-user-name');
        const returnVerificationModal = document.getElementById('return-verification-modal');
        const returnConfirmationModal = document.getElementById('return-confirmation-modal');

        // --- Authentication ---
        document.getElementById('tap-card-btn').addEventListener('click', () => {
            const validUsers = ['USR-002', 'USR-003', 'USR-004'];
            const randomUserId = validUsers[Math.floor(Math.random() * validUsers.length)];
            authenticateUser(randomUserId);
        });

        async function authenticateUser(userId) {
            const tapBtn = document.getElementById('tap-card-btn');
            const originalBtnText = tapBtn.innerHTML;
            tapBtn.innerHTML = '<span class="mr-3">‚è≥</span> Authenticating...';
            tapBtn.disabled = true;

            try {
                // FIXED: Cache Buster
                const response = await fetch(`/api/users/${userId}?t=${Date.now()}`);
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    showAuthenticatedDashboard();
                } else {
                    alert("Invalid User ID.");
                }
            } catch (error) {
                console.error("Auth error:", error);
                alert("Error connecting to server.");
            } finally {
                tapBtn.innerHTML = originalBtnText;
                tapBtn.disabled = false;
            }
        }

        function showAuthenticatedDashboard() {
            idleScreen.classList.add('hidden');
            authDashboard.classList.remove('hidden');
            welcomeUserName.textContent = currentUser.name;
            loadCheckedOutToolsForReturn();
        }

        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            authDashboard.classList.add('hidden');
            checkoutSection.classList.add('hidden');
            returnSection.classList.add('hidden');
            returnVerificationModal.classList.add('hidden');
            returnConfirmationModal.classList.add('hidden');
            idleScreen.classList.remove('hidden');
        });

        // --- Dashboard Navigation ---
        document.getElementById('checkout-card').addEventListener('click', () => {
            authDashboard.classList.add('hidden');
            checkoutSection.classList.remove('hidden');
            loadProjects();
        });

        document.getElementById('return-card').addEventListener('click', () => {
            authDashboard.classList.add('hidden');
            returnSection.classList.remove('hidden');
            loadCheckedOutToolsForReturn();
        });

        document.getElementById('back-to-dashboard-checkout').addEventListener('click', () => {
            checkoutSection.classList.add('hidden');
            authDashboard.classList.remove('hidden');
        });

        document.getElementById('back-to-dashboard-return').addEventListener('click', () => {
            returnSection.classList.add('hidden');
            authDashboard.classList.remove('hidden');
        });

        // --- Project & Tool Loading ---
        async function loadProjects() {
            // FIXED: Cache Buster
            const res = await fetch(`/api/projects?t=${Date.now()}`);
            const projects = await res.json();
            const projectsGrid = document.getElementById('projects-grid');
            projectsGrid.innerHTML = '';
            projects.forEach(p => {
                const card = document.createElement('div');
                card.className = 'action-card p-4 border rounded-lg bg-white cursor-pointer flex flex-col items-center justify-center text-center';
                card.innerHTML = `<div class="font-semibold text-lg">${p.name}</div>`;
                card.onclick = () => showProjectDetails(p.id);
                projectsGrid.appendChild(card);
            });
        }

        async function showProjectDetails(projectId) {
            // FIXED: Cache Buster
            const res = await fetch(`/api/projects/${projectId}?t=${Date.now()}`);
            const project = await res.json();
            
            document.getElementById('project-detail-name').textContent = project.name;
            document.getElementById('project-detail-briefing').textContent = project.briefing;
            currentProjectId = projectId;
            
            const toolIds = JSON.parse(project.tool_list);
            
            // FIXED: Critical Cache Buster to get updated Status
            const allToolsRes = await fetch(`/api/tools?t=${Date.now()}`);
            const allTools = await allToolsRes.json();
            const projectTools = allTools.filter(t => toolIds.includes(t.id));
            
            const projectToolsList = document.getElementById('project-tools-list');
            projectToolsList.innerHTML = '';
            projectTools.forEach(tool => {
                const statusInfo = getToolStatusInfo(tool);
                const toolDiv = document.createElement('div');
                toolDiv.className = 'tool-card p-3 border rounded flex items-center';
                toolDiv.innerHTML = `
                    <input type="checkbox" class="mr-3 project-tool-checkbox h-5 w-5" value="${tool.id}">
                    <div class="flex-1">
                        <div class="font-mono text-sm">${tool.id}</div>
                        <div class="font-semibold">${tool.name}</div>
                        <span class="${statusInfo.class} text-xs px-2 py-0.5 rounded mt-1 inline-block">${statusInfo.text}</span>
                    </div>
                `;
                projectToolsList.appendChild(toolDiv);
            });
            
            document.getElementById('project-view').classList.add('hidden');
            document.getElementById('project-details-view').classList.remove('hidden');
        }

        function getToolStatusInfo(tool) {
            if (tool.status !== 'Available') {
                return { class: 'status-no-go', text: 'NO-GO (Not Available)' };
            }
            if (tool.status === 'Overdue') {
                return { class: 'status-no-go', text: 'NO-GO (Overdue)' };
            } else if (new Date(tool.calibration_due) < new Date()) {
                return { class: 'status-overdue', text: 'NO-GO (Cal Due)' };
            } else if (new Date(tool.calibration_due) < new Date(Date.now() + 7 * 86400000)) {
                return { class: 'status-warning', text: 'WARNING (Due Soon)' };
            } else {
                return { class: 'status-go', text: 'GO' };
            }
        }

        async function loadOverallTools() {
            // FIXED: Cache Buster
            const res = await fetch(`/api/tools/available?t=${Date.now()}`);
            const tools = await res.json();
            const overallToolsGrid = document.getElementById('overall-tools-grid');
            renderToolGrid(tools, overallToolsGrid);
            document.getElementById('project-view').classList.add('hidden');
            document.getElementById('overall-tools-view').classList.remove('hidden');
        }

        function renderToolGrid(tools, gridElement) {
            gridElement.innerHTML = '';
            tools.forEach(tool => {
                const statusInfo = getToolStatusInfo(tool);
                const card = document.createElement('div');
                card.className = 'tool-card p-3 border rounded cursor-pointer';
                card.innerHTML = `
                    <div class="font-mono text-sm">${tool.id}</div>
                    <div class="font-semibold">${tool.name}</div>
                    <span class="${statusInfo.class} text-xs px-2 py-0.5 rounded mt-1 inline-block">${statusInfo.text}</span>
                `;
                card.onclick = () => selectToolForManualCheckout(tool);
                gridElement.appendChild(card);
            });
        }

        function selectToolForManualCheckout(tool) {
            selectedToolForManualCheckout = tool;
            document.querySelectorAll('#overall-tools-grid .tool-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-50');
            });
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
        }

        // --- Navigation within Checkout ---
        document.getElementById('show-overall-tools-btn').onclick = loadOverallTools;
        document.getElementById('back-to-projects-btn').onclick = () => {
            document.getElementById('project-details-view').classList.add('hidden');
            document.getElementById('project-view').classList.remove('hidden');
        };
        document.getElementById('back-to-projects-from-overall-btn').onclick = () => {
            document.getElementById('overall-tools-view').classList.add('hidden');
            document.getElementById('project-view').classList.remove('hidden');
        };

        // --- Batch Checkout ---
        document.getElementById('checkout-selected-tools-btn').onclick = async () => {
            const selectedIds = Array.from(document.querySelectorAll('.project-tool-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                alert("Please select at least one tool.");
                return;
            }
            await performBatchCheckout(selectedIds);
        };

        document.getElementById('checkout-all-tools-btn').onclick = async () => {
            const allIds = Array.from(document.querySelectorAll('.project-tool-checkbox')).map(cb => cb.value);
            await performBatchCheckout(allIds);
        };

        async function performBatchCheckout(toolIds) {
            const res = await fetch(`/api/projects/${currentProjectId}/checkout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUser.id, tool_ids: toolIds })
            });
            const result = await res.json();
            let message = `Batch checkout complete!\nChecked out: ${result.checked_out.length}\nUnavailable: ${result.unavailable.length}`;
            if (result.errors.length > 0) message += `\nErrors: ${result.errors.length}`;
            alert(message);
            authDashboard.classList.remove('hidden');
            checkoutSection.classList.add('hidden');
            loadCheckedOutToolsForReturn();
        }

        // --- Manual Checkout ---
        document.getElementById('manual-checkout-btn').onclick = async () => {
            if (!selectedToolForManualCheckout) {
                alert("Please select a tool first.");
                return;
            }
            const res = await fetch('/api/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentUser.id, tool_id: selectedToolForManualCheckout.id })
            });
            if (res.ok) {
                alert("‚úÖ Checkout successful!");
                authDashboard.classList.remove('hidden');
                checkoutSection.classList.add('hidden');
                loadCheckedOutToolsForReturn();
            } else {
                const error = await res.json();
                alert(`‚ùå ${error.message}`);
            }
        };

        // --- Return Tools Flow ---
        async function loadCheckedOutToolsForReturn() {
            if (!currentUser) return;
            // FIXED: Cache Buster
            const res = await fetch(`/api/tools?t=${Date.now()}`);
            const allTools = await res.json();
            const checkedOutByUser = allTools.filter(t => t.current_holder === currentUser.id && t.status === 'In Use');
            const returnToolsList = document.getElementById('return-tools-list');
            const noToolsMessage = document.getElementById('no-tools-message');
            
            if (checkedOutByUser.length === 0) {
                noToolsMessage.classList.remove('hidden');
                returnToolsList.classList.add('hidden');
            } else {
                noToolsMessage.classList.add('hidden');
                returnToolsList.classList.remove('hidden');
                returnToolsList.innerHTML = '';
                checkedOutByUser.forEach(tool => {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'tool-card p-3 border rounded flex justify-between items-center';
                    toolDiv.innerHTML = `
                        <div>
                            <div class="font-mono text-sm">${tool.id}</div>
                            <div class="font-semibold">${tool.name}</div>
                            <div class="text-xs text-gray-500">Checked out: ${new Date(tool.calibration_due).toLocaleString()}</div>
                        </div>
                        <button class="return-tool-btn bg-green-600 text-white py-2 px-4 rounded text-sm" 
                                data-tool-id="${tool.id}" 
                                data-tool-name="${tool.name}">Return</button>
                    `;
                    returnToolsList.appendChild(toolDiv);
                });
                
                // Add event listeners
                document.querySelectorAll('.return-tool-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        toolToReturn = e.currentTarget.dataset.toolId;
                        toolToReturnName = e.currentTarget.dataset.toolName;
                        showReturnVerificationModal();
                    });
                });
            }
        }

        function showReturnVerificationModal() {
            returnVerificationModal.classList.remove('hidden');
        }

        document.getElementById('simulate-verification-btn').addEventListener('click', () => {
            returnVerificationModal.classList.add('hidden');
            showReturnConfirmationModal();
        });

        document.getElementById('cancel-verification-btn').addEventListener('click', () => {
            returnVerificationModal.classList.add('hidden');
        });

        function showReturnConfirmationModal() {
            document.getElementById('confirm-tool-name').textContent = `Tool: ${toolToReturnName}`;
            returnConfirmationModal.classList.remove('hidden');
        }

        document.getElementById('back-to-verification-btn').addEventListener('click', () => {
            returnConfirmationModal.classList.add('hidden');
            showReturnVerificationModal();
        });

        document.getElementById('confirm-return-btn').addEventListener('click', async () => {
            const reportIssue = document.getElementById('report-issue-checkbox').checked;
            await performToolReturn(toolToReturn, reportIssue);
            returnConfirmationModal.classList.add('hidden');
        });

        async function performToolReturn(toolId, reportIssue) {
            const res = await fetch('/api/checkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tool_id: toolId, report_issue: reportIssue })
            });
            if (res.ok) {
                alert("‚úÖ Tool returned successfully!");
                loadCheckedOutToolsForReturn();
            } else {
                const error = await res.json();
                alert(`‚ùå ${error.message}`);
            }
        }
    </script>
</body>
</html>