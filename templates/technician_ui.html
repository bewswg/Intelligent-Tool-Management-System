<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Tool Station - Technician</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === CUSTOM STYLES === */
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-select { user-select: none; -webkit-user-select: none; }

        /* Card Interactions */
        .action-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-card:active { transform: scale(0.98); background-color: #f8fafc; }

        /* NFC Animation */
        .nfc-pulse { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Scrollbar Polish */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Modal Backdrop */
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 h-screen w-screen overflow-hidden text-slate-800 no-select">

    <div id="app-container" class="h-full w-full flex flex-col relative">
        
        <div id="idle-screen" class="flex-1 flex flex-col items-center justify-center bg-white z-50">
            <div class="text-center space-y-2 mb-12">
                <h1 class="text-5xl font-extrabold text-slate-900 tracking-tight">Smart Tool Station</h1>
                <p class="text-slate-500 text-xl font-medium">Restricted Access â€¢ Technician Only</p>
            </div>

            <div class="relative flex items-center justify-center w-64 h-64 mb-12">
                <div class="absolute inset-0 bg-blue-100 rounded-full nfc-pulse"></div>
                <div class="absolute inset-8 bg-blue-200 rounded-full nfc-pulse" style="animation-delay: 0.5s"></div>
                <div class="relative z-10 bg-white p-10 rounded-full shadow-2xl border-4 border-white">
                    <i class="fas fa-wifi text-8xl text-blue-600"></i>
                </div>
            </div>

            <p class="text-slate-400 font-mono text-base mb-8 animate-pulse font-medium">Waiting for NFC Tag...</p>

            <div class="absolute bottom-8 left-0 right-0 flex justify-center opacity-80 hover:opacity-100 transition-opacity">
                <div class="bg-slate-100 p-2 rounded-xl flex gap-2 border border-slate-200 shadow-sm">
                    <select id="sim-user-select" class="p-2 pr-8 border-none bg-transparent text-sm font-bold text-slate-600 focus:ring-0 cursor-pointer">
                        <option>Loading users...</option>
                    </select>
                    <button id="sim-login-btn" class="bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition shadow">
                        Simulate Tap
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboard-screen" class="hidden flex-col h-full bg-slate-50">
            <header class="bg-white px-8 py-5 shadow-sm border-b border-slate-200 flex justify-between items-center flex-none">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl font-bold">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 leading-none mb-1">Welcome, <span id="user-name" class="text-blue-600">Technician</span></h2>
                        <p class="text-slate-500 text-sm font-medium">Ready for tasks</p>
                    </div>
                </div>
                <button onclick="logout()" class="group flex items-center gap-3 text-slate-500 hover:text-red-600 font-bold transition px-5 py-3 rounded-xl hover:bg-red-50">
                    <span>Log Out</span>
                    <i class="fas fa-sign-out-alt group-hover:translate-x-1 transition-transform"></i>
                </button>
            </header>

            <main class="flex-1 p-8 flex items-center justify-center">
                <div class="grid grid-cols-3 gap-8 w-full max-w-6xl h-full max-h-[500px]">
                    <div onclick="navTo('checkout')" class="action-card bg-white rounded-3xl shadow-sm border-2 border-slate-100 p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:border-blue-300 hover:shadow-xl relative overflow-hidden group">
                        <div class="w-24 h-24 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                            <i class="fas fa-toolbox text-4xl text-blue-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-800 mb-2">Check Out</h3>
                        <p class="text-slate-500 font-medium">Get tools & kits</p>
                    </div>

                    <div onclick="navTo('return')" class="action-card bg-white rounded-3xl shadow-sm border-2 border-slate-100 p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:border-green-300 hover:shadow-xl relative overflow-hidden group">
                        <div class="w-24 h-24 bg-green-50 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                            <i class="fas fa-undo text-4xl text-green-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-800 mb-2">Return</h3>
                        <p class="text-slate-500 font-medium">Check-in items</p>
                    </div>

                    <div onclick="navTo('report')" class="action-card bg-white rounded-3xl shadow-sm border-2 border-slate-100 p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:border-red-300 hover:shadow-xl relative overflow-hidden group">
                        <div class="w-24 h-24 bg-red-50 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-600"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-800 mb-2">Report</h3>
                        <p class="text-slate-500 font-medium">Flag defects</p>
                    </div>
                </div>
            </main>
        </div>

        <div id="checkout-screen" class="hidden flex-col h-full bg-slate-50">
            <header class="bg-white px-6 py-4 shadow-sm border-b border-slate-200 flex justify-between items-center flex-none z-20">
                <div class="flex items-center gap-4">
                    <button onclick="navTo('dashboard')" class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center hover:bg-slate-200 active:scale-95 transition text-slate-600">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-slate-800">Check Out</h2>
                </div>
                <div class="bg-slate-100 p-1.5 rounded-xl flex shadow-inner">
                    <button onclick="switchCheckoutMode('project')" id="tab-project" class="px-6 py-2.5 rounded-lg text-sm font-bold shadow-sm bg-white text-blue-700 transition-all">Projects</button>
                    <button onclick="switchCheckoutMode('all')" id="tab-all" class="px-6 py-2.5 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 transition-all">All Tools</button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div id="view-projects" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

                <div id="view-project-detail" class="hidden h-full flex flex-col max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="p-8 border-b border-slate-100 bg-blue-50/50 flex-none">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 id="proj-det-name" class="text-3xl font-bold text-slate-900 mb-2">Project Name</h3>
                                <p id="proj-det-brief" class="text-slate-600 text-lg">Briefing details...</p>
                            </div>
                            <div class="bg-blue-100 text-blue-700 font-bold px-4 py-2 rounded-lg text-sm">PROJ KIT</div>
                        </div>
                    </div>
                    <div class="p-8 flex-1 overflow-y-auto">
                        <h4 class="font-bold text-slate-400 mb-4 uppercase text-xs tracking-wider">Required Models & Assignments</h4>
                        <div id="proj-det-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6"></div>
                    </div>
                    <div class="p-6 border-t border-slate-100 bg-slate-50 flex gap-4 flex-none">
                        <button onclick="switchCheckoutMode('project')" class="px-8 py-4 border-2 border-slate-300 rounded-xl font-bold text-slate-600 hover:bg-white transition">Cancel</button>
                        <button onclick="checkoutProjectBatch()" class="flex-1 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white py-4 rounded-xl font-bold text-lg shadow-lg transition flex items-center justify-center gap-3">
                            <span>Confirm Checkout</span><i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <div id="view-all-tools" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            </main>
        </div>

        <div id="return-screen" class="hidden flex-col h-full bg-slate-50">
             <header class="bg-white px-6 py-4 shadow-sm border-b border-slate-200 flex justify-between items-center flex-none z-20">
                <div class="flex items-center gap-4">
                    <button onclick="navTo('dashboard')" class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center hover:bg-slate-200 active:scale-95 transition text-slate-600">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Return Tools</h2>
                        <p class="text-sm text-slate-500 font-medium">Select items to check in</p>
                    </div>
                </div>
                <label class="flex items-center gap-3 bg-slate-100 px-4 py-2 rounded-lg cursor-pointer hover:bg-slate-200 transition select-none">
                    <input type="checkbox" id="return-select-all" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-slate-300">
                    <span class="text-sm font-bold text-slate-700">Select All</span>
                </label>
            </header>

            <main class="flex-1 overflow-y-auto p-6 pb-32">
                <div id="return-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div id="return-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400">
                    <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-check text-4xl text-slate-300"></i>
                    </div>
                    <p class="text-lg font-medium">No tools currently checked out.</p>
                </div>
            </main>

            <div id="return-footer" class="absolute bottom-8 left-0 right-0 flex justify-center hidden z-30 pointer-events-none">
                <div class="bg-slate-900 text-white p-2 pl-6 rounded-2xl shadow-2xl flex items-center gap-6 pointer-events-auto transform transition-all hover:scale-105">
                    <div class="font-bold flex items-center gap-2">
                        <span id="return-count" class="bg-blue-500 min-w-[1.5rem] h-6 px-1 rounded-md text-sm flex items-center justify-center">0</span> 
                        <span>Selected</span>
                    </div>
                    <button onclick="openReturnModal()" class="bg-white text-slate-900 px-8 py-3 rounded-xl font-bold hover:bg-blue-50 transition flex items-center gap-2">
                        Return Items <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-report" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-red-50">
                <h3 class="text-xl font-bold text-red-800 flex items-center gap-2"><i class="fas fa-exclamation-circle"></i> Report Issue</h3>
                <button onclick="closeModal('modal-report')" class="w-8 h-8 rounded-full bg-red-100 text-red-500 hover:bg-red-200 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8">
                <div id="rep-step-1">
                    <p class="mb-4 text-slate-500 font-bold text-sm uppercase tracking-wide">Select Defective Tool</p>
                    <div id="rep-my-tools" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8"></div>
                    <div class="relative mb-2">
                        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="rep-search" placeholder="Search entire inventory..." class="w-full pl-12 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500 outline-none" onkeyup="filterReportTools()">
                    </div>
                    <div id="rep-all-tools" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto pr-2"></div>
                </div>

                <div id="rep-step-2" class="hidden">
                    <div class="flex items-start gap-4 mb-6">
                        <button onclick="repStep(1)" class="mt-1 text-slate-400 hover:text-slate-600"><i class="fas fa-arrow-left"></i> Back</button>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100 flex-1">
                            <span class="text-xs font-bold text-red-400 uppercase tracking-wider">Reporting Issue For</span>
                            <div id="rep-tool-name" class="text-xl font-bold text-red-900 mt-1">Tool Name</div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Defect Type</label>
                        <select id="rep-type" class="w-full p-4 border border-slate-200 rounded-xl bg-slate-50 focus:ring-2 focus:ring-red-500 outline-none">
                            <option>Physical Damage</option><option>Calibration Error</option><option>Battery Issue</option><option>Other</option>
                        </select>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Description</label>
                        <textarea id="rep-desc" rows="3" class="w-full p-4 border border-slate-200 rounded-xl bg-slate-50 focus:ring-2 focus:ring-red-500 outline-none resize-none"></textarea>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-end">
                <button id="btn-submit-rep" onclick="submitReport()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg hidden w-full md:w-auto">Submit Report</button>
            </div>
        </div>
    </div>

    <div id="modal-return-verify" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-md w-full border-4 border-white">
            <div class="w-24 h-24 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-box-open text-5xl text-green-600"></i></div>
            <h3 class="text-2xl font-bold text-slate-900 mb-2">Return Tools</h3>
            <p class="text-slate-500 mb-8 leading-relaxed">Place the selected tools securely back into the Smart Box.</p>
            <div class="flex gap-4">
                <button onclick="closeModal('modal-return-verify')" class="flex-1 py-4 text-slate-600 font-bold hover:bg-slate-50 rounded-xl">Cancel</button>
                <button onclick="submitReturn()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // === STATE ===
        let currentUser = null;
        let allTools = [];
        let allProjects = [];
        let returnSelection = new Set();
        let currentProjectId = null;
        let reportSelectedTool = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadSimUsers();
            setInterval(checkNfc, 1000);
        });

        // --- AUTH ---
        async function checkNfc() {
            if(currentUser) return; 
            try {
                const res = await fetch('/api/nfc/poll');
                const data = await res.json();
                if(data.user_id) login(data.user_id);
            } catch(e) { }
        }

        async function loadSimUsers() {
            try {
                const users = await (await fetch('/api/users')).json();
                document.getElementById('sim-user-select').innerHTML = users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                document.getElementById('sim-login-btn').onclick = () => login(document.getElementById('sim-user-select').value);
            } catch(e) { console.log("API Waiting..."); }
        }

        async function login(uid) {
            const res = await fetch(`/api/users/${uid}`);
            if(res.ok) {
                currentUser = await res.json();
                document.getElementById('user-name').innerText = currentUser.name.split(' ')[0];
                switchScreen('dashboard');
            } else { alert("User not found"); }
        }

        function logout() {
            currentUser = null;
            switchScreen('idle');
        }

        function switchScreen(screenName) {
            ['idle', 'dashboard', 'checkout', 'return'].forEach(s => {
                const el = document.getElementById(`${s}-screen`);
                el.classList.remove('flex');
                el.classList.add('hidden');
            });
            const target = document.getElementById(`${screenName}-screen`);
            target.classList.remove('hidden');
            target.classList.add('flex');
        }

        function navTo(page) {
            if(page === 'checkout') loadCheckout();
            if(page === 'return') loadReturn();
            if(page === 'report') openReportModal();
            if(page === 'dashboard') switchScreen('dashboard');
        }

        // --- CHECKOUT LOGIC ---
        async function loadCheckout() {
            switchScreen('checkout');
            switchCheckoutMode('project');
            allProjects = await (await fetch('/api/projects')).json();
            allTools = await (await fetch('/api/tools/available')).json();
            renderProjects();
            renderAllTools();
        }

        function switchCheckoutMode(mode) {
            const tabProj = document.getElementById('tab-project');
            const tabAll = document.getElementById('tab-all');
            const viewProj = document.getElementById('view-projects');
            const viewDetail = document.getElementById('view-project-detail');
            const viewAll = document.getElementById('view-all-tools');

            if(mode === 'project') {
                tabProj.classList.add('bg-white', 'text-blue-700', 'shadow-sm'); tabProj.classList.remove('text-slate-500');
                tabAll.classList.remove('bg-white', 'text-blue-700', 'shadow-sm'); tabAll.classList.add('text-slate-500');
                viewProj.classList.remove('hidden');
                viewAll.classList.add('hidden');
                viewDetail.classList.add('hidden');
            } else {
                tabAll.classList.add('bg-white', 'text-blue-700', 'shadow-sm'); tabAll.classList.remove('text-slate-500');
                tabProj.classList.remove('bg-white', 'text-blue-700', 'shadow-sm'); tabProj.classList.add('text-slate-500');
                viewProj.classList.add('hidden');
                viewDetail.classList.add('hidden');
                viewAll.classList.remove('hidden');
            }
        }

        function renderProjects() {
            document.getElementById('view-projects').innerHTML = allProjects.map(p => {
                const tCount = JSON.parse(p.tool_list).length;
                return `
                <div onclick="openProjectDetail('${p.id}')" class="bg-white p-6 rounded-2xl border border-slate-200 cursor-pointer hover:border-blue-400 hover:shadow-lg transition-all active:scale-[0.98]">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-14 h-14 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 text-2xl font-bold shadow-sm">${p.name.charAt(0)}</div>
                        <span class="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1.5 rounded-lg uppercase tracking-wider">${tCount} Models</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1 line-clamp-1">${p.name}</h3>
                    <p class="text-slate-500 text-sm line-clamp-2">${p.briefing}</p>
                </div>`;
            }).join('');
        }

        function renderAllTools() {
            document.getElementById('view-all-tools').innerHTML = allTools.map(t => `
                <div onclick="checkoutSingle('${t.id}')" class="bg-white p-5 rounded-2xl border border-slate-200 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all active:scale-[0.98] flex flex-col justify-between min-h-[140px]">
                    <div>
                        <p class="text-xs font-bold font-mono text-slate-400 mb-2">${t.id}</p>
                        <h4 class="font-bold text-slate-700 text-base leading-tight">${t.name}</h4>
                    </div>
                    <div class="mt-4 flex justify-end"><div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-plus"></i></div></div>
                </div>
            `).join('');
        }

        // === NEW DYNAMIC PROJECT LOGIC ===
        async function openProjectDetail(pid) {
            const p = allProjects.find(x => x.id === pid);
            currentProjectId = pid;
            
            document.getElementById('view-projects').classList.add('hidden');
            document.getElementById('view-project-detail').classList.remove('hidden');
            
            document.getElementById('proj-det-name').innerText = p.name;
            document.getElementById('proj-det-brief').innerText = p.briefing;

            // NEW: Fetch all tools to find availability by MODEL
            const requiredModels = JSON.parse(p.tool_list);
            const fullInv = await (await fetch('/api/tools')).json();
            
            const list = document.getElementById('proj-det-list');
            list.innerHTML = requiredModels.map(modelCode => {
                // Find first available tool of this model
                const availableTool = fullInv.find(t => t.model === modelCode && t.status === 'Available');
                const anyTool = fullInv.find(t => t.model === modelCode);
                const displayName = anyTool ? anyTool.name : "Unknown Tool";

                if (availableTool) {
                    return `
                    <label class="flex items-center p-4 border rounded-xl bg-white border-slate-200 hover:border-blue-300 transition-colors cursor-pointer">
                        <div class="flex items-center justify-center w-6 h-6 mr-4">
                            <input type="checkbox" class="proj-cb w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300" value="${availableTool.id}" checked>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-sm text-slate-800">${displayName}</div>
                            <div class="text-xs text-blue-600 font-bold font-mono">Assigned: ${availableTool.id}</div>
                        </div>
                        <span class="text-[10px] font-bold text-green-700 bg-green-100 px-2 py-1 rounded">READY</span>
                    </label>`;
                } else {
                    return `
                    <label class="flex items-center p-4 border rounded-xl bg-slate-50 border-slate-100 opacity-60 cursor-not-allowed">
                        <div class="flex items-center justify-center w-6 h-6 mr-4">
                            <input type="checkbox" class="w-5 h-5 rounded border-gray-300" disabled>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-sm text-slate-500">${displayName}</div>
                            <div class="text-xs text-red-400 font-mono">Out of Stock</div>
                        </div>
                        <span class="text-[10px] font-bold text-red-700 bg-red-100 px-2 py-1 rounded">BUSY</span>
                    </label>`;
                }
            }).join('');
        }

        async function checkoutProjectBatch() {
            const selected = Array.from(document.querySelectorAll('.proj-cb:checked')).map(cb => cb.value);
            if(selected.length === 0) return alert("No available tools selected.");
            
            await fetch(`/api/projects/${currentProjectId}/checkout`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({user_id: currentUser.id, tool_ids: selected})
            });
            navTo('dashboard');
        }

        async function checkoutSingle(tid) {
            if(confirm("Check out this tool?")) {
                await fetch('/api/checkout', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({user_id: currentUser.id, tool_id: tid})
                });
                loadCheckout(); 
            }
        }

        // --- RETURN LOGIC ---
        async function loadReturn() {
            switchScreen('return');
            const tools = await (await fetch('/api/tools')).json();
            const myTools = tools.filter(t => t.current_holder === currentUser.id && t.status === 'In Use');
            
            const list = document.getElementById('return-list');
            const empty = document.getElementById('return-empty');
            returnSelection.clear(); updateReturnFooter();
            document.getElementById('return-select-all').checked = false;

            if(myTools.length === 0) { list.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            else { list.classList.remove('hidden'); empty.classList.add('hidden'); }

            list.innerHTML = myTools.map(t => `
                <label class="relative flex items-center p-5 bg-white border-2 border-slate-200 rounded-2xl cursor-pointer hover:border-blue-400 transition shadow-sm active:scale-[0.99] select-none">
                    <input type="checkbox" class="return-cb w-6 h-6 rounded text-blue-600 focus:ring-0 border-slate-300 mr-5" value="${t.id}">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-800 text-lg mb-1">${t.name}</h4>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-500">${t.id}</span>
                            <span class="text-xs text-orange-600 font-bold bg-orange-50 px-2 py-0.5 rounded">Due: ${t.calibration_due}</span>
                        </div>
                    </div>
                </label>
            `).join('');

            document.querySelectorAll('.return-cb').forEach(cb => cb.addEventListener('change', (e) => {
                e.target.checked ? returnSelection.add(e.target.value) : returnSelection.delete(e.target.value);
                updateReturnFooter();
            }));
        }

        document.getElementById('return-select-all').addEventListener('change', (e) => {
            const cbs = document.querySelectorAll('.return-cb');
            cbs.forEach(cb => { cb.checked = e.target.checked; e.target.checked ? returnSelection.add(cb.value) : returnSelection.delete(cb.value); });
            updateReturnFooter();
        });

        function updateReturnFooter() {
            const footer = document.getElementById('return-footer');
            document.getElementById('return-count').innerText = returnSelection.size;
            if(returnSelection.size > 0) footer.classList.remove('hidden'); else footer.classList.add('hidden');
        }

        function openReturnModal() { document.getElementById('modal-return-verify').classList.remove('hidden'); }

        async function submitReturn() {
            for(const id of returnSelection) { await fetch('/api/checkin', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tool_id: id}) }); }
            closeModal('modal-return-verify'); navTo('dashboard');
        }

        // --- REPORT LOGIC ---
        async function openReportModal() {
            const tools = await (await fetch('/api/tools')).json();
            const myTools = tools.filter(t => t.current_holder === currentUser.id && t.status === 'In Use');
            allTools = tools; 

            document.getElementById('rep-my-tools').innerHTML = myTools.map(t => `
                <div onclick="selectReportTool('${t.id}', '${t.name}')" class="p-4 bg-red-50 border border-red-100 rounded-xl flex justify-between items-center cursor-pointer hover:bg-red-100 hover:shadow-sm active:scale-95 transition">
                    <div><div class="font-bold text-red-900">${t.name}</div><div class="text-xs font-mono text-red-400 mt-1">${t.id}</div></div><i class="fas fa-chevron-right text-red-300"></i>
                </div>
            `).join('') || '<div class="col-span-full text-center p-4 text-slate-400 text-sm italic border-2 border-dashed border-slate-200 rounded-xl">No tools currently checked out by you. Search below.</div>';

            filterReportTools(); repStep(1); document.getElementById('modal-report').classList.remove('hidden');
        }

        function filterReportTools() {
            const term = document.getElementById('rep-search').value.toLowerCase();
            const results = allTools.filter(t => t.name.toLowerCase().includes(term) || t.id.toLowerCase().includes(term));
            document.getElementById('rep-all-tools').innerHTML = results.slice(0,12).map(t => `<div onclick="selectReportTool('${t.id}', '${t.name}')" class="p-3 border border-slate-200 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 hover:border-blue-300 cursor-pointer truncate transition">${t.name}</div>`).join('');
        }

        function selectReportTool(id, name) {
            reportSelectedTool = {id, name}; document.getElementById('rep-tool-name').innerText = name; repStep(2);
        }

        function repStep(n) {
            if(n===1) { document.getElementById('rep-step-1').classList.remove('hidden'); document.getElementById('rep-step-2').classList.add('hidden'); document.getElementById('btn-submit-rep').classList.add('hidden'); }
            else { document.getElementById('rep-step-1').classList.add('hidden'); document.getElementById('rep-step-2').classList.remove('hidden'); document.getElementById('btn-submit-rep').classList.remove('hidden'); }
        }

        async function submitReport() {
            const desc = document.getElementById('rep-desc').value; if(!desc) return alert("Description required");
            await fetch('/api/issues', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tool_id: reportSelectedTool.id, reporter_id: currentUser.id, defect_type: document.getElementById('rep-type').value, description: desc }) });
            closeModal('modal-report'); navTo('dashboard');
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>