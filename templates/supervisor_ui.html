<!-- templates/supervisor_ui.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Supervisor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .sort-arrow {
            margin-left: 4px;
            font-size: 0.8em;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="flex">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 text-white min-h-screen">
        <div class="p-4 text-xl font-bold">Tool Management</div>
        <nav class="mt-6">
            <a href="#" class="block px-4 py-2 hover:bg-gray-700 active-page" data-page="dashboard">Dashboard</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-700" data-page="live-view">Live View</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-700" data-page="inventory">Inventory</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-700" data-page="users">Users</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-700" data-page="calibration">Calibration</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-700" data-page="audit-trail">Audit Trail</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-6">
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page active">
            <h1 class="text-2xl font-bold mb-6">Dashboard</h1>
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500">Available</h3>
                    <p class="text-2xl" id="kpi-available">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500">In Use</h3>
                    <p class="text-2xl" id="kpi-in-use">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500">Overdue</h3>
                    <p class="text-2xl" id="kpi-overdue">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-gray-500">Under Maintenance</h3>
                    <p class="text-2xl" id="kpi-maintenance">0</p>
                </div>
            </div>

            <!-- AI Forecast Button -->
            <div class="mb-6">
                <button id="ai-forecast-btn" class="bg-purple-600 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-robot mr-2"></i> Run AI Calibration Forecast
                </button>
            </div>

            <!-- Alerts Panel -->
            <div class="bg-white p-4 rounded shadow mb-6">
                <h2 class="text-xl font-semibold mb-4">Critical Alerts</h2>
                <div id="alerts-container" class="space-y-2">
                    <!-- Alerts will be inserted here -->
                </div>
                <div id="no-alerts" class="text-gray-500">No active alerts.</div>
            </div>

            <!-- Activity Log -->
            <div class="bg-white p-4 rounded shadow mt-6">
                <h2 class="text-xl font-semibold mb-4">Recent Activity Log</h2>
                <div class="text-sm text-gray-600 mb-2">Last 20 transactions</div>
                <div id="activity-log" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Log entries will appear here -->
                </div>
            </div>

            <!-- Emergency Unlock -->
            <div class="bg-red-50 p-4 rounded shadow mt-6">
                <h2 class="text-xl font-semibold mb-2 text-red-800">Emergency Manual Unlock</h2>
                <p class="mb-3">Use only in case of system failure.</p>
                <button id="emergency-btn" class="bg-red-600 text-white px-4 py-2 rounded">Trigger Unlock</button>
            </div>
        </div>

        <!-- Live View Page -->
        <div id="live-view-page" class="page">
            <h1 class="text-2xl font-bold mb-4">Live Tool Usage</h1>
            <p class="text-gray-600 mb-4">Real-time view of tools currently in use.</p>
            <div class="bg-white p-4 rounded shadow">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-3 text-left">Tool</th>
                            <th class="p-3 text-left">User</th>
                            <th class="p-3 text-left">Status</th>
                            <th class="p-3 text-left">Time Held</th>
                        </tr>
                    </thead>
                    <tbody id="live-view-table-body">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
                <div id="no-live-tools" class="text-gray-500 p-4 text-center hidden">
                    No tools are currently in use.
                </div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventory-page" class="page">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Tool Inventory</h1>
                <button id="add-tool-btn" class="bg-blue-600 text-white px-3 py-1 rounded">+ Add Tool</button>
            </div>
            <div class="mb-4 flex flex-wrap gap-2">
                <span class="font-medium self-center">Filter by Status:</span>
                <button class="filter-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 active" data-status="all">All</button>
                <button class="filter-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" data-status="Available">Available</button>
                <button class="filter-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" data-status="In Use">In Use</button>
                <button class="filter-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" data-status="Overdue">Overdue</button>
                <button class="filter-btn px-3 py-1 rounded bg-gray-200 hover:bg-gray-300" data-status="Under Maintenance">Under Maintenance</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border rounded">
                    <thead class="bg-gray-200 text-left">
                        <tr>
                            <th class="p-3 cursor-pointer sort-header" data-column="id">ID <span class="sort-arrow"></span></th>
                            <th class="p-3 cursor-pointer sort-header" data-column="name">Name <span class="sort-arrow"></span></th>
                            <th class="p-3 cursor-pointer sort-header" data-column="status">Status <span class="sort-arrow"></span></th>
                            <th class="p-3 cursor-pointer sort-header" data-column="current_holder">Holder <span class="sort-arrow"></span></th>
                            <th class="p-3 cursor-pointer sort-header" data-column="calibration_due">Calibration Due <span class="sort-arrow"></span></th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="divide-y">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Page -->
        <div id="users-page" class="page">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">User Management</h1>
                <button id="add-user-btn" class="bg-blue-600 text-white px-3 py-1 rounded">+ Add User</button>
            </div>
            <table class="min-w-full bg-white border rounded">
                <thead class="bg-gray-200 text-left">
                    <tr>
                        <th class="p-3">ID</th>
                        <th class="p-3">Name</th>
                        <th class="p-3">Role</th>
                        <th class="p-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>

        <!-- Calibration Page -->
        <div id="calibration-page" class="page">
            <h1 class="text-2xl font-bold mb-4">Calibration Calendar</h1>
            <div class="bg-white p-4 rounded shadow mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="text-blue-600"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-month" class="text-xl font-semibold">October 2025</h2>
                    <button id="next-month" class="text-blue-600"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Audit Trail Page -->
        <div id="audit-trail-page" class="page">
            <h1 class="text-2xl font-bold mb-4">Audit Trail Explorer</h1>
            <p class="text-gray-600 mb-4">Searchable log of all system events for compliance and review.</p>
            <div class="mb-4 flex gap-2 flex-wrap">
                <input type="text" id="audit-search" placeholder="Search details..." class="px-3 py-1 border rounded">
                <select id="audit-action-filter" class="px-3 py-1 border rounded">
                    <option value="">All Actions</option>
                    <option value="EMERGENCY_UNLOCK">Emergency Unlock</option>
                    <option value="TOOL_CHECKOUT">Tool Checkout</option>
                    <option value="TOOL_CHECKIN">Tool Check-in</option>
                    <option value="TOOL_CREATED">Tool Created</option>
                    <option value="TOOL_DELETED">Tool Deleted</option>
                </select>
                <button id="audit-apply-filters" class="bg-gray-600 text-white px-3 py-1 rounded">Apply</button>
            </div>
            <div class="bg-white p-4 rounded shadow overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-3 text-left">Timestamp</th>
                            <th class="p-3 text-left">User</th>
                            <th class="p-3 text-left">Action</th>
                            <th class="p-3 text-left">Details</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table-body">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
                <div id="no-audit-logs" class="text-gray-500 p-4 text-center hidden">
                    No audit logs found.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="tool-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded w-1/3">
        <h2 class="text-xl font-bold mb-4" id="tool-modal-title">Add New Tool</h2>
        <input type="text" id="tool-id" placeholder="Tool ID" class="w-full p-2 border mb-2">
        <input type="text" id="tool-name" placeholder="Tool Name" class="w-full p-2 border mb-2">
        <input type="date" id="tool-cal-date" class="w-full p-2 border mb-2">
        <select id="tool-status" class="w-full p-2 border mb-4">
            <option value="Available">Available</option>
            <option value="In Use">In Use</option>
            <option value="Overdue">Overdue</option>
            <option value="Under Maintenance">Under Maintenance</option>
        </select>
        <div class="flex justify-end space-x-2">
            <button id="cancel-tool" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
            <button id="save-tool" class="px-3 py-1 bg-blue-600 text-white rounded">Save</button>
        </div>
    </div>
</div>

<div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded w-1/3">
        <h2 class="text-xl font-bold mb-4" id="user-modal-title">Add New User</h2>
        <input type="text" id="user-id" placeholder="User ID" class="w-full p-2 border mb-2">
        <input type="text" id="user-name" placeholder="Full Name" class="w-full p-2 border mb-2">
        <select id="user-role" class="w-full p-2 border mb-4">
            <option value="Technician">Technician</option>
            <option value="Supervisor">Supervisor</option>
        </select>
        <div class="flex justify-end space-x-2">
            <button id="cancel-user" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
            <button id="save-user" class="px-3 py-1 bg-blue-600 text-white rounded">Save</button>
        </div>
    </div>
</div>

<div id="emergency-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded w-1/3">
        <h2 class="text-xl font-bold mb-2 text-red-800">Emergency Manual Unlock</h2>
        <p class="mb-4">This action will be logged. Please provide a reason.</p>
        <textarea id="unlock-reason" placeholder="Reason for emergency unlock..." class="w-full p-2 border mb-4" rows="3"></textarea>
        <div class="flex justify-end space-x-2">
            <button id="cancel-emergency" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
            <button id="confirm-emergency" class="px-3 py-1 bg-red-600 text-white rounded">Confirm Unlock</button>
        </div>
    </div>
</div>

<div id="tools-due-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4">Tools Due on <span id="modal-date"></span></h2>
        <ul id="tools-due-list" class="list-disc pl-5 space-y-1"></ul>
        <button id="close-tools-modal" class="mt-4 bg-gray-600 text-white px-3 py-1 rounded">Close</button>
    </div>
</div>

<script>
// Global state
let currentPage = 'dashboard';
let allTools = [];
let allUsers = [];
let currentFilter = 'all';
let currentSort = { column: 'id', direction: 'asc' };
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// === PAGE NAVIGATION ===
document.querySelectorAll('[data-page]').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = e.target.dataset.page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`${page}-page`).classList.add('active');
        document.querySelectorAll('.active-page').forEach(el => el.classList.remove('active-page'));
        e.target.classList.add('active-page');
        currentPage = page;
        if (page === 'live-view') loadLiveView();
        if (page === 'calibration') loadCalendar();
        if (page === 'inventory') loadInventory();
        if (page === 'users') loadUsers();
        if (page === 'audit-trail') loadAuditTrail();
    });
});

// === AI FORECAST BUTTON ===
document.getElementById('ai-forecast-btn').addEventListener('click', async () => {
    const btn = document.getElementById('ai-forecast-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Running...';
    
    const res = await fetch('/api/calibration/predict', { method: 'POST' });
    const data = await res.json();
    
    if (res.ok) {
        alert(`✅ ${data.message}!`);
        if (currentPage === 'calibration') loadCalendar();
        if (currentPage === 'inventory') loadInventory();
    } else {
        alert(`❌ Error: ${data.error || data.message}`);
    }
    
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot mr-2"></i> Run AI Calibration Forecast';
});

// === DASHBOARD: Load KPIs & Alerts ===
async function loadDashboard() {
    const toolsRes = await fetch('/api/tools');
    const tools = await toolsRes.json();
    const counts = { 'Available': 0, 'In Use': 0, 'Overdue': 0, 'Under Maintenance': 0 };
    tools.forEach(t => counts[t.status] = (counts[t.status] || 0) + 1);
    document.getElementById('kpi-available').textContent = counts['Available'] || 0;
    document.getElementById('kpi-in-use').textContent = counts['In Use'] || 0;
    document.getElementById('kpi-overdue').textContent = counts['Overdue'] || 0;
    document.getElementById('kpi-maintenance').textContent = counts['Under Maintenance'] || 0;

    const alertsRes = await fetch('/api/alerts');
    const alerts = await alertsRes.json();
    const container = document.getElementById('alerts-container');
    const noAlerts = document.getElementById('no-alerts');
    container.innerHTML = '';
    let hasAlerts = false;

    alerts.overdue.forEach(tool => {
        hasAlerts = true;
        container.innerHTML += `
            <div class="bg-yellow-100 border-l-4 border-yellow-500 p-3">
                <strong>OVERDUE:</strong> ${tool.name} (${tool.id}) is past its calibration date.
            </div>
        `;
    });

    alerts.long_checkout.forEach(tool => {
        hasAlerts = true;
        container.innerHTML += `
            <div class="bg-red-100 border-l-4 border-red-500 p-3">
                <strong>LONG CHECKOUT:</strong> ${tool.name} has been checked out for over 8 hours.
            </div>
        `;
    });

    noAlerts.style.display = hasAlerts ? 'none' : 'block';
}

// === ACTIVITY LOG ===
async function loadActivityLog() {
    const res = await fetch('/api/transactions');
    const transactions = await res.json();
    const logEl = document.getElementById('activity-log');
    logEl.innerHTML = '';
    transactions.forEach(tx => {
        const color = tx.type === 'checkout' ? 'text-blue-600' : 'text-green-600';
        logEl.innerHTML += `
            <div class="flex justify-between border-b pb-1">
                <span><span class="font-mono">${tx.tool_name}</span> was <span class="${color}">${tx.type}</span> by ${tx.user_name}</span>
                <span class="text-gray-500 text-xs">${tx.timestamp}</span>
            </div>
        `;
    });
}

// === LIVE VIEW ===
async function loadLiveView() {
    const res = await fetch('/api/live-view');
    const liveTools = await res.json();
    const tableBody = document.getElementById('live-view-table-body');
    const noToolsEl = document.getElementById('no-live-tools');
    
    tableBody.innerHTML = '';
    
    if (liveTools.length === 0) {
        noToolsEl.classList.remove('hidden');
        return;
    }
    
    noToolsEl.classList.add('hidden');
    
    liveTools.forEach(tool => {
        const totalSeconds = parseInt(tool.seconds_held);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const timeHeld = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        let statusClass = 'bg-green-100 text-green-800';
        if (tool.tool_status === 'Overdue') statusClass = 'bg-yellow-100 text-yellow-800';
        if (tool.tool_status === 'In Use' && totalSeconds > 8 * 3600) {
            statusClass = 'bg-red-100 text-red-800';
        }

        const row = `
            <tr class="border-b">
                <td class="p-3 font-mono">${tool.tool_id}<br><span class="font-semibold">${tool.tool_name}</span></td>
                <td class="p-3">${tool.user_name} (${tool.user_id})</td>
                <td class="p-3"><span class="${statusClass} text-xs px-2 py-0.5 rounded">${tool.tool_status}</span></td>
                <td class="p-3 font-mono">${timeHeld}</td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    });
}

// === AUDIT TRAIL ===
let allAuditLogs = [];

async function loadAuditTrail() {
    const res = await fetch('/api/audit-trail');
    allAuditLogs = await res.json();
    renderAuditTable();
}

function renderAuditTable(filters = {}) {
    const tableBody = document.getElementById('audit-table-body');
    const noLogsEl = document.getElementById('no-audit-logs');
    
    let filteredLogs = allAuditLogs;
    
    if (filters.search) {
        const term = filters.search.toLowerCase();
        filteredLogs = filteredLogs.filter(log => 
            (log.details && log.details.toLowerCase().includes(term)) ||
            (log.action && log.action.toLowerCase().includes(term))
        );
    }
    
    if (filters.action) {
        filteredLogs = filteredLogs.filter(log => log.action === filters.action);
    }
    
    tableBody.innerHTML = '';
    
    if (filteredLogs.length === 0) {
        noLogsEl.classList.remove('hidden');
        return;
    }
    
    noLogsEl.classList.add('hidden');
    
    filteredLogs.forEach(log => {
        let detailsText = log.details || '—';
        try {
            const detailsObj = JSON.parse(log.details);
            detailsText = Object.entries(detailsObj)
                .map(([k, v]) => `${k}: ${v}`)
                .join(', ');
        } catch (e) {
            // Keep as plain text
        }
        
        const row = `
            <tr class="border-b text-sm">
                <td class="p-3 font-mono">${log.timestamp}</td>
                <td class="p-3">${log.user_name || log.user_id || 'System'}</td>
                <td class="p-3"><span class="bg-gray-100 px-2 py-0.5 rounded">${log.action}</span></td>
                <td class="p-3 max-w-xs truncate">${detailsText}</td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    });
}

document.getElementById('audit-apply-filters').addEventListener('click', () => {
    const search = document.getElementById('audit-search').value;
    const action = document.getElementById('audit-action-filter').value;
    renderAuditTable({ search, action });
});

// === INVENTORY: Filtering & Sorting ===
async function loadInventory() {
    const response = await fetch('/api/tools');
    allTools = await response.json();
    renderInventoryTable();
}

function renderInventoryTable() {
    const tableBody = document.getElementById('inventory-table-body');
    tableBody.innerHTML = '';

    let filteredTools = allTools;
    if (currentFilter !== 'all') {
        filteredTools = allTools.filter(tool => tool.status === currentFilter);
    }

    filteredTools.sort((a, b) => {
        let valA = a[currentSort.column] || '';
        let valB = b[currentSort.column] || '';
        if (currentSort.column === 'calibration_due') {
            valA = new Date(valA);
            valB = new Date(valB);
        }
        if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
        }
        let comparison = 0;
        if (valA > valB) comparison = 1;
        else if (valA < valB) comparison = -1;
        return currentSort.direction === 'asc' ? comparison : -comparison;
    });

    filteredTools.forEach(tool => {
        let statusClass = 'bg-green-100 text-green-800';
        if (tool.status === 'In Use') statusClass = 'bg-red-100 text-red-800';
        if (tool.status === 'Overdue') statusClass = 'bg-yellow-100 text-yellow-800';
        if (tool.status === 'Under Maintenance') statusClass = 'bg-gray-100 text-gray-800';

        const row = `
            <tr>
                <td class="p-3 font-mono">${tool.id}</td>
                <td class="p-3 font-semibold">${tool.name}</td>
                <td class="p-3 text-center"><span class="${statusClass} text-xs px-2 py-0.5 rounded">${tool.status}</span></td>
                <td class="p-3">${tool.current_holder || '—'}</td>
                <td class="p-3">${tool.calibration_due}</td>
                <td class="p-3 text-center">
                    <button class="edit-tool text-blue-600 hover:underline mr-2" data-id="${tool.id}">Edit</button>
                    <button class="delete-tool text-red-600 hover:underline" data-id="${tool.id}">Delete</button>
                </td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    });

    document.querySelectorAll('.edit-tool').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const tool = allTools.find(t => t.id === id);
            document.getElementById('tool-modal-title').textContent = 'Edit Tool';
            document.getElementById('tool-id').value = tool.id;
            document.getElementById('tool-id').disabled = true;
            document.getElementById('tool-name').value = tool.name;
            document.getElementById('tool-cal-date').value = tool.calibration_due;
            document.getElementById('tool-status').value = tool.status;
            document.getElementById('tool-modal').classList.remove('hidden');
        });
    });

    document.querySelectorAll('.delete-tool').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (confirm('Delete this tool?')) {
                const id = btn.dataset.id;
                await fetch(`/api/tools/${id}`, { method: 'DELETE' });
                loadInventory();
            }
        });
    });
}

document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.status;
        renderInventoryTable();
    });
});

document.querySelectorAll('.sort-header').forEach(header => {
    header.addEventListener('click', () => {
        const column = header.dataset.column;
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        document.querySelectorAll('.sort-arrow').forEach(arrow => arrow.textContent = '');
        header.querySelector('.sort-arrow').textContent = currentSort.direction === 'asc' ? ' ↑' : ' ↓';
        renderInventoryTable();
    });
});

// === USERS ===
async function loadUsers() {
    const response = await fetch('/api/users');
    allUsers = await response.json();
    const tableBody = document.getElementById('users-table-body');
    tableBody.innerHTML = '';
    allUsers.forEach(user => {
        const row = `
            <tr>
                <td class="p-3 font-mono">${user.id}</td>
                <td class="p-3">${user.name}</td>
                <td class="p-3">${user.role}</td>
                <td class="p-3">
                    <button class="edit-user text-blue-600 hover:underline mr-2" data-id="${user.id}">Edit</button>
                    <button class="delete-user text-red-600 hover:underline" data-id="${user.id}">Delete</button>
                </td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
    });

    document.querySelectorAll('.edit-user').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const user = allUsers.find(u => u.id === id);
            document.getElementById('user-modal-title').textContent = 'Edit User';
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-id').disabled = true;
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-role').value = user.role;
            document.getElementById('user-modal').classList.remove('hidden');
        });
    });

    document.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (confirm('Delete this user?')) {
                const id = btn.dataset.id;
                await fetch(`/api/users/${id}`, { method: 'DELETE' });
                loadUsers();
            }
        });
    });
}

// === CALENDAR ===
function getDaysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
}

function getFirstDayOfMonth(year, month) {
    return new Date(year, month - 1, 1).getDay();
}

let currentMonthEvents = {};

async function loadCalendar() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    document.getElementById('calendar-month').textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;

    const res = await fetch(`/api/calibration/events?year=${currentYear}&month=${currentMonth}`);
    const events = await res.json();
    currentMonthEvents = events;

    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = `
        <div class="text-center font-bold p-2">Sun</div>
        <div class="text-center font-bold p-2">Mon</div>
        <div class="text-center font-bold p-2">Tue</div>
        <div class="text-center font-bold p-2">Wed</div>
        <div class="text-center font-bold p-2">Thu</div>
        <div class="text-center font-bold p-2">Fri</div>
        <div class="text-center font-bold p-2">Sat</div>
    `;

    const daysInMonth = getDaysInMonth(currentYear, currentMonth);
    const firstDay = getFirstDayOfMonth(currentYear, currentMonth);

    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += '<div class="p-2 border"></div>';
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const count = events[dateStr] || 0;
        const bubble = count > 0 ? `<div class="w-6 h-6 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center mx-auto">${count}</div>` : '';
        grid.innerHTML += `
            <div class="p-2 border text-center calendar-day" data-date="${dateStr}">
                <div>${day}</div>
                ${bubble}
            </div>
        `;
    }

    document.querySelectorAll('.calendar-day').forEach(dayEl => {
        const date = dayEl.dataset.date;
        if (currentMonthEvents[date] && currentMonthEvents[date] > 0) {
            dayEl.style.cursor = 'pointer';
            dayEl.style.backgroundColor = '#dbeafe';
            dayEl.addEventListener('click', () => showToolsDueOnDate(date));
        }
    });
}

async function showToolsDueOnDate(date) {
    const toolsRes = await fetch('/api/tools');
    const tools = await toolsRes.json();
    const toolsDue = tools.filter(tool => tool.calibration_due === date);

    document.getElementById('modal-date').textContent = date;
    const listEl = document.getElementById('tools-due-list');
    listEl.innerHTML = '';
    if (toolsDue.length === 0) {
        listEl.innerHTML = '<li>No tools found.</li>';
    } else {
        toolsDue.forEach(tool => {
            const li = document.createElement('li');
            li.textContent = `${tool.name} (${tool.id})`;
            listEl.appendChild(li);
        });
    }
    document.getElementById('tools-due-modal').style.display = 'flex';
}

document.getElementById('close-tools-modal').addEventListener('click', () => {
    document.getElementById('tools-due-modal').style.display = 'none';
});

document.getElementById('tools-due-modal').addEventListener('click', (e) => {
    if (e.target.id === 'tools-due-modal') {
        document.getElementById('tools-due-modal').style.display = 'none';
    }
});

document.getElementById('prev-month').addEventListener('click', () => {
    if (currentMonth === 1) {
        currentMonth = 12;
        currentYear--;
    } else {
        currentMonth--;
    }
    loadCalendar();
});

document.getElementById('next-month').addEventListener('click', () => {
    if (currentMonth === 12) {
        currentMonth = 1;
        currentYear++;
    } else {
        currentMonth++;
    }
    loadCalendar();
});

// === MODALS ===
document.getElementById('add-tool-btn').addEventListener('click', () => {
    document.getElementById('tool-modal-title').textContent = 'Add New Tool';
    document.getElementById('tool-id').value = '';
    document.getElementById('tool-id').disabled = false;
    document.getElementById('tool-name').value = '';
    document.getElementById('tool-cal-date').value = '';
    document.getElementById('tool-status').value = 'Available';
    document.getElementById('tool-modal').classList.remove('hidden');
});

document.getElementById('cancel-tool').addEventListener('click', () => {
    document.getElementById('tool-modal').classList.add('hidden');
});

document.getElementById('save-tool').addEventListener('click', async () => {
    const id = document.getElementById('tool-id').value;
    const name = document.getElementById('tool-name').value;
    const calDate = document.getElementById('tool-cal-date').value;
    const status = document.getElementById('tool-status').value;
    if (!id || !name || !calDate) {
        alert('All fields are required.');
        return;
    }

    if (document.getElementById('tool-id').disabled) {
        await fetch(`/api/tools/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, calibration_due: calDate })
        });
        await fetch(`/api/tools/${id}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
    } else {
        await fetch('/api/tools', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, name, calibration_due: calDate })
        });
    }
    document.getElementById('tool-modal').classList.add('hidden');
    if (currentPage === 'inventory') loadInventory();
});

document.getElementById('add-user-btn').addEventListener('click', () => {
    document.getElementById('user-modal-title').textContent = 'Add New User';
    document.getElementById('user-id').value = '';
    document.getElementById('user-id').disabled = false;
    document.getElementById('user-name').value = '';
    document.getElementById('user-role').value = 'Technician';
    document.getElementById('user-modal').classList.remove('hidden');
});

document.getElementById('cancel-user').addEventListener('click', () => {
    document.getElementById('user-modal').classList.add('hidden');
});

document.getElementById('save-user').addEventListener('click', async () => {
    const id = document.getElementById('user-id').value;
    const name = document.getElementById('user-name').value;
    const role = document.getElementById('user-role').value;
    if (!id || !name || !role) {
        alert('All fields are required.');
        return;
    }
    const payload = { id, name, role };
    const url = document.getElementById('user-id').disabled ? `/api/users/${id}` : '/api/users';
    const method = document.getElementById('user-id').disabled ? 'PUT' : 'POST';
    await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    document.getElementById('user-modal').classList.add('hidden');
    if (currentPage === 'users') loadUsers();
});

document.getElementById('emergency-btn').addEventListener('click', () => {
    document.getElementById('emergency-modal').classList.remove('hidden');
});

document.getElementById('cancel-emergency').addEventListener('click', () => {
    document.getElementById('emergency-modal').classList.add('hidden');
});

document.getElementById('confirm-emergency').addEventListener('click', async () => {
    const reason = document.getElementById('unlock-reason').value;
    if (!reason) {
        alert('Please provide a reason.');
        return;
    }
    await fetch('/api/unlock/emergency', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
    });
    alert('Emergency unlock triggered!');
    document.getElementById('emergency-modal').classList.add('hidden');
});

// === INITIALIZE ON LOAD ===
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
    setInterval(loadDashboard, 30000);
    loadActivityLog();
    setInterval(loadActivityLog, 15000);
    loadLiveView();
    setInterval(loadLiveView, 10000);
    loadInventory();
    loadUsers();
    loadCalendar();
    loadAuditTrail();
});
</script>

</body>
</html>